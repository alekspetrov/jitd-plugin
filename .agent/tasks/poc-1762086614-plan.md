# POC-1762086614: Multi-Claude v4.5.0 Reliability Fixes

**Created**: 2025-11-02
**Type**: Multi-Claude POC Implementation
**Parent Task**: TASK-25
**Priority**: High
**Target**: v4.5.0

---

## Feature Description

Implement reliability improvements for multi-Claude workflow to increase success rate from 30% to 90%+ through:

1. **Retry logic** - Automatic phase retry when marker creation fails
2. **Timeout detection** - Sub-Claude self-monitoring to detect stuck processes
3. **Phase recovery** - State persistence and workflow resume capability
4. **Marker verification** - Enhanced logging and validation
5. **Improved prompts** - Explicit marker invocation instructions

This addresses the main failure mode: marker timeouts in Phase 3 (Testing) that cause complete workflow failure.

---

## Implementation Steps

### Step 1: Retry Logic Foundation
**Files**: `scripts/navigator-multi-claude.sh`, `scripts/navigator-multi-claude-poc.sh`

Add retry wrapper function:
```bash
wait_for_marker_with_retry() {
  local marker_file=$1
  local max_retries=${2:-1}
  local timeout=${3:-120}

  for attempt in $(seq 1 $((max_retries + 1))); do
    if wait_for_file "$marker_file" "$timeout"; then
      return 0
    fi

    if [ $attempt -le $max_retries ]; then
      restart_current_phase
    else
      return 1
    fi
  done
}
```

Update all `wait_for_file` calls to use `wait_for_marker_with_retry`.

### Step 2: Sub-Claude Timeout Monitoring
**Files**: `scripts/sub-claude-monitor.sh` (new)

Create monitoring script that:
- Runs alongside headless Claude instance
- Tracks elapsed time per phase
- Checks for completion markers before timeout kill
- Exits cleanly when marker found or timeout exceeded

Integration in orchestrator:
```bash
claude -p "$PROMPT" --resume "$SESSION_ID" &
CLAUDE_PID=$!
./scripts/sub-claude-monitor.sh "$PHASE" "$TIMEOUT" "$CLAUDE_PID" &
wait $CLAUDE_PID
```

### Step 3: Phase State Persistence
**Files**: `scripts/navigator-multi-claude.sh`

Create state file `.agent/tasks/SESSION_ID-state.json`:
```json
{
  "session_id": "poc-1762086614",
  "task": "Multi-Claude v4.5.0 fixes",
  "phases_completed": ["phase0", "phase1"],
  "current_phase": "phase2",
  "phase_attempts": {"phase2": 1},
  "started_at": "2025-11-02T10:00:00Z",
  "last_update": "2025-11-02T10:15:00Z"
}
```

Update state after each phase completion.

### Step 4: Workflow Resume Capability
**Files**: `scripts/resume-workflow.sh` (new)

Create standalone resume script:
- Read state from `SESSION_ID-state.json`
- Display completed/current phases
- Prompt to resume from last checkpoint
- Restart current phase with retry enabled

### Step 5: Enhanced Marker Verification
**Files**: `skills/nav-marker/SKILL.md`

Add verification after marker creation:
- Check file exists and non-empty
- Create MD5 checksum for verification
- Log to central `.agent/.marker-log`
- Report success/failure with metadata

Orchestrator verification:
- Validate marker exists
- Check non-empty
- Verify checksum if present

### Step 6: Improved Sub-Claude Prompts
**Files**: `scripts/navigator-multi-claude.sh`, `scripts/navigator-multi-claude-poc.sh`

Update all phase prompts with explicit marker instructions:

```
CRITICAL: You MUST create a completion marker when done.

Steps:
1. [Phase-specific tasks]
2. Create completion marker:

   INVOKE: nav-marker skill with name "phase{N}-{phase-name}-complete"

   Marker file: .agent/tasks/{SESSION_ID}-{phase}-done
   This is REQUIRED for orchestrator to proceed.
```

### Step 7: Testing Infrastructure
**Files**: `tests/test-retry-logic.sh`, `tests/test-monitor.sh`, `tests/test-recovery.sh` (new)

Create test scripts:
- **test-retry-logic.sh** - Simulate marker failures, verify retry
- **test-monitor.sh** - Simulate stuck Claude, verify timeout kill
- **test-recovery.sh** - Kill mid-workflow, verify resume

### Step 8: Integration Testing
Run full workflows:
- 5 simple POCs (1-2 file changes)
- 3 medium workflows (3-5 files)
- Measure success rate
- Debug failures

### Step 9: Documentation
**Files**:
- `RELEASE-NOTES-v4.5.0.md` (new)
- `.agent/sops/development/multi-claude-troubleshooting.md` (new)
- `scripts/POC-LEARNINGS.md` (update)

Document:
- v4.5.0 improvements
- Troubleshooting guide for marker timeouts
- Resume workflow instructions
- Test results and metrics

---

## Files to Modify

### New Files (6)
1. `scripts/sub-claude-monitor.sh` - Timeout detection (~60 lines)
2. `scripts/resume-workflow.sh` - Workflow resume (~100 lines)
3. `tests/test-retry-logic.sh` - Retry tests (~50 lines)
4. `tests/test-monitor.sh` - Monitor tests (~40 lines)
5. `tests/test-recovery.sh` - Recovery tests (~60 lines)
6. `RELEASE-NOTES-v4.5.0.md` - Release notes (~100 lines)

### Modified Files (5)
1. `scripts/navigator-multi-claude.sh` (~200 lines added)
   - Retry logic
   - State tracking
   - Monitor integration
   - Marker verification

2. `scripts/navigator-multi-claude-poc.sh` (~100 lines added)
   - Retry logic
   - Updated prompts

3. `skills/nav-marker/SKILL.md` (~30 lines added)
   - Enhanced logging
   - Checksum verification

4. `scripts/POC-LEARNINGS.md` (~50 lines added)
   - v4.5.0 improvements summary

5. `.agent/sops/development/multi-claude-troubleshooting.md` (new, ~200 lines)
   - Troubleshooting guide

### Log Files (1)
1. `.agent/.marker-log` - Central marker event log

**Total estimated**: ~600 new lines, ~380 modified lines

---

## Expected Outcome

### Success Metrics
- **Marker creation reliability**: 95%+ (from ~60%)
- **Phase transition success**: 95%+ (from ~70%)
- **Automatic recovery**: 80%+ workflows resume successfully
- **Overall success rate**: 90%+ (from 30%)

### Behavioral Changes
**Before v4.5.0**:
```
[15:24:49] Phase 3: Testing
[15:26:51] ‚ùå Timeout - no marker
Workflow failed - manual intervention required
```

**After v4.5.0**:
```
[15:24:49] Phase 3: Testing (Attempt 1)
[15:26:51] ‚ö†Ô∏è Timeout - retrying phase
[15:27:00] Phase 3: Testing (Attempt 2)
[15:28:30] ‚úÖ Marker found: poc-XXX-tests-done
[15:28:30] ‚úÖ Phase 3 complete
```

Or with recovery:
```
[15:26:51] ‚ùå Phase 3 timeout after retry
[15:26:51] üíæ State saved to: poc-XXX-state.json
[15:26:51] Resume with: ./scripts/resume-workflow.sh poc-XXX

$ ./scripts/resume-workflow.sh poc-XXX
üìã Resuming workflow: poc-XXX
   Completed: phase0, phase1, phase2
   Current: phase3
Resume? [Y/n] y
[15:30:00] Resuming Phase 3...
[15:31:15] ‚úÖ Phase 3 complete
```

### User Experience Impact
- **No manual marker creation needed** - Retry handles transient failures
- **No data loss on timeout** - State persisted, workflow resumable
- **Clear visibility** - Logs show retry attempts and recovery options
- **Higher confidence** - 90%+ success rate makes workflows production-ready

---

## Testing Plan

### Unit Tests (Per Component)
```bash
# Test retry logic
./tests/test-retry-logic.sh
# Expected: Retry succeeds on 2nd attempt

# Test monitor timeout
./tests/test-monitor.sh
# Expected: Monitor kills stuck process after 3 min

# Test recovery
./tests/test-recovery.sh
# Expected: Resume from Phase 3 checkpoint
```

### Integration Tests (Full Workflows)
```bash
# Simple: Add function
navigator-multi-claude-poc.sh "Add hello world function"
# Expected: 5/5 success

# Medium: Multi-file feature
navigator-multi-claude.sh "Implement JWT authentication"
# Expected: 4/5 success (80%+)

# Complex: Integration
navigator-multi-claude.sh "Add OAuth2 Google provider"
# Expected: 3/5 success (60%+, acceptable for complex)
```

### Success Criteria
- ‚úÖ 10 simple POCs: 90%+ success (9/10)
- ‚úÖ 5 medium workflows: 80%+ success (4/5)
- ‚úÖ Retry logic triggers: 40%+ of phases (proves value)
- ‚úÖ Recovery works: 100% of interrupted workflows (5/5)

---

## Risk Mitigation

### High Risk: Monitor Kills Valid Claude
**Mitigation**:
- Conservative 3-minute timeout (double current)
- Check for marker before kill
- Log kill decisions to `.agent/.marker-log`

### Medium Risk: Retry Infinite Loop
**Mitigation**:
- Max 1 retry per phase (2 attempts total)
- Global 30-minute workflow timeout
- State file tracks retry attempts

### Low Risk: Disk Space from Logs
**Mitigation**:
- Rotate `.agent/.marker-log` (keep last 100 entries)
- Cleanup state files on workflow completion
- Document log maintenance in troubleshooting guide

---

## Completion Checklist

- [ ] All 6 new files created
- [ ] All 5 files modified with retry/monitor/verify logic
- [ ] Unit tests pass (retry, monitor, recovery)
- [ ] Integration tests: 90%+ simple, 80%+ medium
- [ ] Release notes drafted
- [ ] Troubleshooting guide written
- [ ] POC-LEARNINGS.md updated
- [ ] Version bumped to v4.5.0 in marketplace.json
- [ ] Committed with message: `feat(v4.5.0): multi-claude reliability fixes - retry, timeout, recovery`

---

**Ready to implement**: This POC validates the TASK-25 solution design through actual implementation and testing.
